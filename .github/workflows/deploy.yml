name: Flujo de despliegue para API Bank 
on: 
  push: 
    branches: ["main"]
env: 
  APP_NAME: api-bank
jobs: 
  build-y-despliegue: 
    name: flujo de despliegue
    runs-on: ubuntu-latest 
    if: github.ref == 'refs/heads/main'
    steps: 
      - name: Descargar código fuente (Checkout)
        uses: actions/checkout@v4
      
      - name: Iniciar sesión en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Construir y subir imagen Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:latest
        
      - name: Desplegar en Servidor VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            # Preparar directorio de la aplicación
            mkdir -p /opt/${{ env.APP_NAME }}
            cd /opt/${{ env.APP_NAME }}
            
            # Crear archivo de variables de entorno (.env)
            echo "Generando archivo .env..."
            cat > .env << EOF
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            PG_DB_USERNAME=${{ secrets.PG_DB_USERNAME }}
            PG_DB_PASSWORD=${{ secrets.PG_DB_PASSWORD }}
            PG_DB_NAME=${{ secrets.PG_DB_NAME }}
            PORT=3000
            EOF
            
            # Crear archivo docker-compose.prod.yml
            echo "Generando docker-compose.prod.yml..."
            cat > docker-compose.prod.yml << 'DOCKERCOMPOSE'
            version: '3.8'
            services:
              app:
                container_name: bank-api
                image: ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:latest
                restart: always
                ports:
                  - "3000:3000"
                env_file: .env
            DOCKERCOMPOSE
            
            # Desplegar nueva versión
            echo "Desplegando nueva versión..."
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml up -d
            
            # Limpiar imágenes antiguas
            echo "Limpiando imágenes antiguas..."
            docker image prune -f